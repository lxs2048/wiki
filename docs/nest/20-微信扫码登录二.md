# å¾®ä¿¡ç™»å½•æ–¹æ¡ˆäºŒ

## å‡†å¤‡å·¥ä½œ

### æ¥å£æƒé™

![image-20221207013321007](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212070133045.png!blog.guiyexing)

### å†…ç½‘ç©¿é€

å‚è€ƒä¸€ä¸‹ï¼š[Ngrok-æ•™ä½ å…è´¹æŠŠæœ¬åœ°é¡¹ç›®éƒ¨ç½²åˆ°å¤–ç½‘](https://juejin.cn/post/6935691723385339941)

ç›®çš„ï¼šä½¿å¾—æœ¬åœ°çš„æœåŠ¡å™¨å¯ä»¥è¢«å…¬ç½‘æœåŠ¡å™¨è®¿é—®åˆ°

![image-20221208004711325](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212080047347.png!blog.guiyexing)

è¿™é‡Œé€šè¿‡è®¿é—®é…ç½®çš„å…¬ç½‘`http://suidao.free.idcfengye.com`å°±å¯ä»¥è®¿é—®åˆ°æœ¬åœ°çš„`127.0.0.1:3000`ï¼Œæ–¹ä¾¿è°ƒè¯•

### åŸºæœ¬é…ç½®

![image-20221207012856847](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212070129466.png!blog.guiyexing)

å¦‚æœèƒ½æäº¤å‡ºå»ä¹‹å**è®°å¾—å¯åŠ¨**

æäº¤æ¡ä»¶ï¼š**éªŒè¯æ¶ˆæ¯çš„ç¡®æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨**ï¼Œå¾®ä¿¡ä¼šå‘å¡«å†™çš„URLåœ°å€å‘é€getè¯·æ±‚ï¼Œå¹¶å¯åŠ¨æ‹¼æ¥ä¸€äº›å‚æ•°ï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡ŒéªŒè¯å¹¶è¿”å›

è¯¦ç»†è¯·çœ‹[æ¥å…¥æŒ‡å—ç¬¬äºŒæ­¥](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html)

æˆ‘çš„Urlä¸º`http://suidao.free.idcfengye.com/vx`

ç„¶åæˆ‘ä»¬å¯åŠ¨æœ¬åœ°serveræœåŠ¡å™¨ï¼Œå¢åŠ è·¯ç”±

```
nest g res vx
```

```ts title="vx.controller.ts"
import { wxVerify } from 'src/vx/utils';
@Get()
wxEditConfiguration(@Query() query) {
  return wxVerify(query);
}
```

```ts title="src/vx/utils/index.ts"
// eslint-disable-next-line @typescript-eslint/no-var-requires
const sha1 = require('sha1');

export interface IVerifyOption {
  signature: string; // å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„ token å‚æ•°å’Œè¯·æ±‚ä¸­çš„ timestamp å‚æ•°ã€nonceå‚æ•°ã€‚
  timestamp: string; // æ—¶é—´æˆ³
  nonce: string; // éšæœºæ•°
  echostr?: string; // éšæœºå­—ç¬¦ä¸²
}
/* æ ¡éªŒå¾®ä¿¡ */
export const VerifyStatus = {
  success: 'success',
  error: 'error',
};
export const wxVerify = ({
  signature,
  timestamp,
  nonce,
  echostr,
}: IVerifyOption) => {
  if (!signature || !timestamp || !nonce) {
    return VerifyStatus.error;
  }
  // å®šä¹‰çš„token
  const token = process.env.CUSTOMTOKEN;
  //å°†Tokenï¼Œtimestampï¼ŒnonceæŒ‰å­—å…¸æ’åº,æ’åºåé“¾æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
  const str = [token, timestamp, nonce].sort().join('');
  //ä½¿ç”¨sha1æ¨¡å—è¿›è¡Œsha1åŠ å¯†
  const sha1Str = sha1(str);
  //åˆ¤æ–­åŠ å¯†åçš„å­—ç¬¦ä¸²ä¸è¯·æ±‚ä¸­signatureæ˜¯å¦ç›¸ç­‰
  if (sha1Str === signature) {
    //å¦‚æœç›¸ç­‰è¿”å›echostrå°†echostrè¿”å›ç»™å¾®ä¿¡æœåŠ¡å™¨
    return echostr || VerifyStatus.success; // é™¤ä¿®æ”¹æœåŠ¡å™¨é…ç½®æäº¤æ ¡éªŒéœ€éšæœºç ï¼Œå…¶ä»–è‡ªå®šä¹‰
  } else {
    return VerifyStatus.error;
  }
};
```

å¾—åˆ°queryåï¼Œæˆ‘ä»¬è‡ªå·±æ‹¼æ¥ä¹Ÿèƒ½å¤Ÿè®¿é—®æˆåŠŸ

![image-20221208010629669](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212080106717.png!blog.guiyexing)

## å­¦ä½ è¯´è¯

å®ç°ä¸€ä¸ªå°åŠŸèƒ½ï¼Œæ— è®ºç”¨æˆ·å‘é€ç»™å…¬ä¼—å·ä»€ä¹ˆæ¶ˆæ¯éƒ½åŸè¯å‘é€ç»™ç”¨æˆ·

å‚è€ƒï¼š

* [æ¥æ”¶æ™®é€šæ¶ˆæ¯](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html)

* [è¢«åŠ¨å›å¤ç”¨æˆ·æ¶ˆæ¯](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Passive_user_reply_message.html)

ä»ç„¶ä½¿ç”¨`http://suidao.free.idcfengye.com/vx`è¿™ä¸ªæ¥å£ï¼Œåªæ˜¯è¯·æ±‚ç±»å‹éœ€è¦ä½¿ç”¨`Post`

ç‰¹åˆ«æ³¨æ„ï¼šnestä½¿ç”¨postæ–¹å¼æˆåŠŸè¿”å›ç»“æœçŠ¶æ€ç ä¸º201ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼Œéœ€æ”¹ä¸º200

* æŠ¥è­¦ç¾¤ï¼šå¾®ä¿¡æœåŠ¡å™¨å‘å…¬ä¼—å·æ¨é€æ¶ˆæ¯æˆ–äº‹ä»¶åï¼Œå¾—åˆ°çš„å›åº”ä¸åˆæ³•
* å…¬ä¼—å·ï¼šè¯¥å…¬ä¼—å·æä¾›çš„æœåŠ¡å‡ºç°æ•…éšœï¼Œè¯·ç¨åå†è¯•

æ³¨å†Œä¸­é—´ä»¶è§£æxml

```ts title="main.ts" {4-8,11-20}
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

// eslint-disable-next-line @typescript-eslint/no-var-requires
const bodyParser = require('body-parser');
// eslint-disable-next-line @typescript-eslint/no-var-requires
require('body-parser-xml')(bodyParser);

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.use(
    bodyParser.xml({
      limit: '1MB', // Reject payload bigger than 1 MB
      xmlParseOptions: {
        normalize: true, // Trim whitespace inside text nodes
        // normalizeTags: true, // Transform tags to lowercase
        explicitArray: false, // Only put nodes in array if >1
      },
    }),
  );
  await app.listen(3000);
}
bootstrap();
```

è§£æxmlè¿”å›ç›¸åº”çš„æ¶ˆæ¯

```ts title="vx.controller.ts"
import {
  VerifyStatus,
  wxVerify,
  IWxMessageXmlData,
  HadleMessage,
} from 'src/vx/utils';

@HttpCode(200)
@Post()
async wxhandler(@Body('xml') xmlData: IWxMessageXmlData, @Query() query) {
  const verifyRet = wxVerify(query);
  if (verifyRet === VerifyStatus.error) {
    // æ ¡éªŒ
    return '';
  }
  return HadleMessage(xmlData);
}
```

è¡¥å……è¾…åŠ©å‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨ç­–ç•¥æ¨¡å¼

```ts title="src/vx/utils/index.ts"
/* è¢«åŠ¨å›å¤ */
/**
 * å¾®ä¿¡å›è°ƒç»™å¼€å‘è€…çš„æ¶ˆæ¯
 */
export interface IWxMessageXmlData {
  /** å¼€å‘è€…å¾®ä¿¡å· e.g. `gh_019087f88815`*/
  ToUserName: string;
  /** å‘é€æ–¹å¸å·ï¼ˆä¸€ä¸ªOpenIDï¼‰e.g.: `o5w5awUl***5pIJKY`*/
  FromUserName: string;
  /** æ¶ˆæ¯åˆ›å»ºæ—¶é—´ ï¼ˆæ•´å‹ï¼‰e.g.`1595855711` */
  CreateTime: string;
  /** æ¶ˆæ¯ç±»å‹ï¼Œæ­¤å¤„ä¸º `event` */
  MsgType: string;
  /** äº‹ä»¶ç±»å‹ï¼Œsubscribe(è®¢é˜…)ã€unsubscribe(å–æ¶ˆè®¢é˜…) */
  Event: 'subscribe' | 'unsubscribe';
  /** äº‹ä»¶KEYå€¼ï¼Œç›®å‰æ— ç”¨ */
  EventKey: string;
  /* å†…å®¹ */
  Content?: string;
}

const MessageType = {
  text: 'text',
  image: 'image',
};

const ReplyActions = {
  [MessageType.text]: (xmlData: IWxMessageXmlData) => {
    return `<xml>
        <ToUserName><![CDATA[${xmlData.FromUserName}]]></ToUserName>
        <FromUserName><![CDATA[${xmlData.ToUserName}]]></FromUserName>
        <CreateTime>${new Date().getTime()}</CreateTime>
        <MsgType><![CDATA[${xmlData.MsgType}]]></MsgType>
        <Content><![CDATA[${xmlData.Content}]]></Content>
      </xml>`;
  },
  [MessageType.image]: () => {
    return '';
  },
};

export const HadleMessage = (xmlData: IWxMessageXmlData) => {
  return ReplyActions[xmlData?.MsgType]?.(xmlData) || '';
};
```

æµ‹è¯•ç»“æœå¦‚ä¸‹

![image-20221211152728061](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212111527103.png!blog.guiyexing)

## æ‰«ç ç™»å½•

å‚è€ƒï¼š

* [è·å–Access token](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)
* [æ¥æ”¶äº‹ä»¶æ¨é€](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html)

`Access token`æ˜¯å…¬ä¼—å·çš„å…¨å±€å”¯ä¸€æ¥å£è°ƒç”¨å‡­æ®ï¼Œaccess_tokençš„æœ‰æ•ˆæœŸç›®å‰ä¸º2ä¸ªå°æ—¶ï¼Œéœ€å®šæ—¶åˆ·æ–°ï¼Œå»ºè®®å…¬ä¼—å·å¼€å‘è€…ä½¿ç”¨ä¸­æ§æœåŠ¡å™¨ç»Ÿä¸€è·å–å’Œåˆ·æ–°access_token

```ts
const tokenData = await axios
.get(
  `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${process.env.APPID}&secret=${process.env.VXSECRET}`,
)
.then((res) => res.data);
console.log(tokenData); //æ‰‹åŠ¨è·å–æ–¹å¼
```

å¼€å‘çš„æ—¶å€™è·å–tokenåå­˜åˆ°ç¯å¢ƒå˜é‡é‡Œï¼Œå®é™…åº”å­˜åˆ°æ•°æ®åº“ï¼Œå®šæ—¶æ›´æ–°

æˆ‘ä»¬ä»åç«¯è·å–ç”Ÿæˆé“¾æ¥çš„åœ°å€

```ts
@Get('createTmpQRCode')
async createTmpQRCode() {
  const ticketData = await axios
  .post(
    `https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=${process.env.TEMP_ACCESS_TOKEN}`,
    {
      expire_seconds: 60 * 30,
      action_name: 'QR_SCENE',
      action_info: {
        scene: {
          scene_id: process.env.LOGIN_SCENE_ID,
        },
      },
    },
  )
  .then((res) => res.data);
  return {
    ...ticketData,
    url: `https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=${ticketData.ticket}`,
  };
}
```

å‰ç«¯æŠŠåœ°å€æ”¾åˆ°é¡µé¢åè½®è®­æ˜¯å¦æ‰«ç ç™»å½•æˆåŠŸ

```ts
import { Button, Modal } from 'antd';
import { useBoolean, useRequest } from 'ahooks';
import axios from 'axios';
const createTmpQRCode = () => {
  return axios.get('/api/vx/createTmpQRCode').then(res=>res.data)
}
const Login = ()=>{
  const { data, loading } = useRequest(createTmpQRCode);
  console.log(data,'æ•°æ®ğŸ˜ğŸ˜ğŸ˜');
  return <div>
    {
      loading?<div>loading...</div>:<div>
        <img style={{width:'200px',height:'200px'}} src={data.url} alt="login image" />
      </div>
    }
  </div>
}

const App: React.FC = () => {
  const [state, { toggle}] = useBoolean(false);
  return (
    <>
      <Button type="primary" onClick={toggle}>
        Open Modal
      </Button>
      <Modal open={state} onCancel={toggle} footer={null} destroyOnClose>
        <Login/>
      </Modal>
    </>
  );
};

export default App;
```

![image-20221211181524658](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202212111815698.png!blog.guiyexing)

åç«¯ç°åœ¨æ‰©å±•ä¸€ä¸‹ç­–ç•¥æ¨¡å¼

```ts {4-27,43-45}
const MessageType = {
  text: 'text',
  image: 'image',
  event: 'event',
};
const EventType = {
  subscribe: 'subscribe', //å…³æ³¨
  unsubscribe: 'unsubscribe', //å–æ¶ˆå…³æ³¨
  SCAN: 'SCAN', //å…³æ³¨åæ‰«ç -å¸¦ä¸åŒçš„åœºæ™¯å€¼æ¥å¤„ç†ä¸åŒçš„é€»è¾‘
};

const EventActions = {
  [EventType.subscribe]: (xmlData: IWxMessageXmlData) => {
    // ç›´æ¥æœç´¢å…³æ³¨EventKeyæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåœºæ™¯å€¼æœ‰"qrscene_"å‰ç¼€
    console.log('æ­£åœ¨å…³æ³¨ï¼š', xmlData.EventKey, xmlData.FromUserName); //å…³æ³¨äº†ï¼Œåˆ¤æ–­äº‹ä»¶å€¼ä¸€è‡´ï¼Œå¤„ç†ç™»å½•
    return '';
  },
  [EventType.unsubscribe]: (xmlData: IWxMessageXmlData) => {
    // åœºæ™¯å€¼æ— å‰ç¼€
    console.log('å–æ¶ˆå…³æ³¨ï¼š', xmlData.FromUserName); //å–æ¶ˆäº†ï¼Œç»™è¿™ä¸ªè´¦æˆ·æ‰“ä¸ªæ ‡è®°å§
    return '';
  },
  [EventType.SCAN]: (xmlData: IWxMessageXmlData) => {
    // å¯ä»¥ç»§ç»­æ‹†åˆ†ï¼Œå¦‚æœæ˜¯ç™»å½•çš„åœºæ™¯å€¼å°±å¤„ç†ç™»å½•
    console.log('å…³æ³¨è¿‡æ‰«ä¸‹', xmlData.EventKey, xmlData.FromUserName); //å…³æ³¨è¿‡ç„¶åæ‰«ç äº†ï¼Œåˆ¤æ–­äº‹ä»¶å€¼ä¸€è‡´ï¼Œå¤„ç†ç™»å½•
    return '';
  },
};

const ReplyActions = {
  [MessageType.text]: (xmlData: IWxMessageXmlData) => {
    return `<xml>
        <ToUserName><![CDATA[${xmlData.FromUserName}]]></ToUserName>
        <FromUserName><![CDATA[${xmlData.ToUserName}]]></FromUserName>
        <CreateTime>${new Date().getTime()}</CreateTime>
        <MsgType><![CDATA[${xmlData.MsgType}]]></MsgType>
        <Content><![CDATA[${xmlData.Content}]]></Content>
      </xml>`;
  },
  [MessageType.image]: () => {
    return '';
  },
  [MessageType.event]: (xmlData: IWxMessageXmlData) => {
    return EventActions[xmlData?.Event]?.(xmlData) || '';
  },
};

export const HadleMessage = (xmlData: IWxMessageXmlData) => {
  return ReplyActions[xmlData?.MsgType]?.(xmlData) || '';
};
```
