# äº¤æ˜“æ‰€

## åŠ å¯†è´§å¸

ä»€ä¹ˆæ˜¯ä»£å¸ï¼š

ä»£å¸å¯ä»¥åœ¨ä»¥å¤ªåŠä¸­è¡¨ç¤ºä»»ä½•ä¸œè¥¿ï¼š

* åœ¨çº¿å¹³å°ä¸­çš„ä¿¡èª‰ç§¯åˆ†
* é‡‘èžèµ„äº§ç±»ä¼¼äºŽå…¬å¸è‚¡ä»½çš„èµ„äº§
* åƒç¾Žå…ƒä¸€æ ·çš„æ³•å®šè´§å¸
* ä¸€ç›Žå¸é»„é‡‘
* åŠæ›´å¤š...

> ERC-20å°±æ˜¯ä¸€å¥—åŸºäºŽä»¥å¤ªåŠç½‘ç»œçš„æ ‡å‡†ä»£å¸å‘è¡Œåè®®ã€‚æœ‰äº†ERC-20ï¼Œå¼€å‘è€…ä»¬å¾—ä»¥é«˜æ•ˆã€å¯é ã€ä½Žæˆæœ¬åœ°åˆ›é€ ä¸“å±žè‡ªå·±é¡¹ç›®çš„ä»£å¸ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†ERC-20è§†ä¸ºä»¥å¤ªåŠç½‘ç»œä¸ºæ—©æœŸåŒºå—é“¾ä¸–ç•Œåšå‡ºçš„æœ€é‡è¦è´¡çŒ®

ERC-20çš„åŠŸèƒ½ç¤ºä¾‹åŒ…æ‹¬ï¼š

* å°†ä»£å¸ä»Žä¸€ä¸ªå¸æˆ·è½¬åˆ°å¦ä¸€ä¸ªå¸æˆ·
* èŽ·å–å¸æˆ·çš„å½“å‰ä»£å¸ä½™é¢
* èŽ·å–ç½‘ç»œä¸Šå¯ç”¨ä»£å¸çš„æ€»ä¾›åº”é‡
* æ‰¹å‡†ä¸€ä¸ªå¸æˆ·ä¸­ä¸€å®šçš„ä»£å¸é‡‘é¢ç”±ç¬¬ä¸‰æ–¹å¸æˆ·ä½¿ç”¨

[A standard interface for tokens](https://eips.ethereum.org/EIPS/eip-20)ï¼Œé€šè¿‡ä¸åŒçš„æ ‡å‡†æŽ¥å£å®žçŽ°è‡ªå·±çš„ä»£å¸ï¼Œå°†æ¥éƒ¨ç½²åœ¨åŒºå—é“¾ä¸Šï¼Œå› ä¸ºä»–æœ¬æ¥å°±æ˜¯æ™ºèƒ½åˆçº¦

## ä»£å¸åˆçº¦

æŽ¥ä¸‹æ¥ä½¿ç”¨ERC-20å†™æˆ‘ä»¬çš„ä»£å¸ï¼ˆåˆçº¦ï¼‰

éœ€è¦å®žçŽ°ERC-20è¦æ±‚çš„æ–¹æ³•ï¼Œå¯¹å¤–å…¬å¼€çš„çŠ¶æ€å˜é‡ä¼šè‡ªåŠ¨ç”Ÿæˆgetteræ–¹æ³•

```solidity title="DolToken.sol"
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.4.16 <0.9.0;
// å¯¼å…¥å®‰å…¨æ•°å­¦æ–¹æ³•
import "openzeppelin-solidity/contracts/math/SafeMath.sol";
contract DolToken {
    using SafeMath for uint256;//ä¸ºuint256åŽé¢ä½¿ç”¨subï¼Œaddæ–¹æ³•
    string public name = 'DolToken';//è‡ªå®šç”Ÿæˆgetteræ–¹æ³•
    string public symbol = 'DOL';//ä»¤ç‰Œçš„åç§°
    uint256 public decimals = 18;//ä»¤ç‰Œä½¿ç”¨çš„å°æ•°ä½æ•°
    uint256 public totalSupply;//ä¾›åº”é‡
    // mappingç±»åž‹
    mapping(address => uint256) public balanceOf;//è¿”å›žåœ°å€ä¸ºä¸€ä¸ªå¸æˆ·çš„å¸æˆ·ä½™é¢
    // äº‹ä»¶åœ¨åˆçº¦ä¸­ä¸€æ—¦è¢«è§¦å‘ï¼Œä¼šæŠŠä¼ é€’è¿›æ¥çš„å‚æ•°å­˜å‚¨åˆ°äº¤æ˜“çš„æ—¥å¿—ä¸­ï¼Œä¸Žåˆçº¦çš„åœ°å€å…³è”ï¼Œåˆå¹¶åˆ°åŒºå—é“¾ä¸­ï¼ŒåŒºå—å¯ä»¥è®¿é—®äº¤æ˜“çš„æ—¥å¿—ï¼Œå‰ç«¯å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œè¿½è¸ªï¼Œå¦‚å‰ç«¯å¯ä»¥ç›‘å¬ä¸€ç¬”äº¤æ˜“å®ŒæˆåŽåœ¨è¯·æ±‚èŽ·å–ä½™é¢ï¼Œè¿˜å¯ä»¥è®¢é˜…transferäº‹ä»¶
    event Transfer(address indexed _from, address indexed _to, uint256 _value);//æœ¬èº«æ˜¯åœ¨ä»£å¸åè®®ä¸­å¿…é¡»è¦æ±‚çš„ï¼Œä¸å¯æ›´æ”¹ï¼Œå…¬å¼€é€æ˜Žï¼Œä»¥å¤ªåŠä¹Ÿä¼šè®¢é˜…è¿™ä¸ªäº‹ä»¶

    constructor(){
        totalSupply = 1000000 * (10 ** decimals);
        // éƒ¨ç½²æ™ºèƒ½åˆçº¦éœ€è¦ä¸€ä¸ªè´¦å·ä»Žé‡Œé¢æ‰£æ¬¾ï¼Œä»Žé…ç½®ä¸­æ‹¿åˆ°fromé‡Œå¡«å†™çš„è´¦æˆ·ï¼Œæµ‹è¯•æ—¶ä¸å¡«é»˜è®¤æ˜¯ç¬¬ä¸€è´¦æˆ·
        balanceOf[msg.sender] = totalSupply;//éƒ¨ç½²è´¦å·æ‹¥æœ‰æ‰€æœ‰ä»£å¸
    }
    function transfer(address _to, uint256 _value) public returns (bool success){
        require(_to != address(0));//éœ€è¦æœ‰æ•ˆåœ°å€
        _transfer(msg.sender, _to, _value);
        return true;
    }
    function _transfer(address _from,address _to,uint256 _value) internal {
        require(balanceOf[_from] >= _value);//trueæ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ï¼Œä¼šè¢«ä»¥å¤ªåŠçš„æŽ¥å£æŽ¥æ”¶çº³å…¥åˆ°æ—¥å¿—ä¸­, åŒæ—¶é€€å›žgas
        // ä»Žå“ªä¸ªè´¦å·å‘èµ·çš„è°ƒç”¨è€…
        balanceOf[_from] = balanceOf[_from].sub(_value);
        balanceOf[_to] = balanceOf[_to].add(_value);
        // è§¦å‘äº‹ä»¶
        emit Transfer(_from, _to, _value);
    }
}
```

å¦å¤–éœ€è¦å®‰è£…ä¸€ä¸ªåº“

```
npm i openzeppelin-solidity
```

æ³¨æ„åœ¨ä½¿ç”¨åº“çš„ä½¿ç”¨ï¼ŒSafeMath.solçº¦æŸsolidityç¼–è¯‘å™¨çš„ç‰ˆæœ¬è¦å°äºŽ8.0ï¼Œç›®å‰é»˜è®¤æ˜¯`0.8.19`ï¼Œéœ€è¦é™ä½Žï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„`compilers.solc.version`ä¸º`0.7.5`æˆ–è€…å…¶ä»–é€‚åˆçš„ç‰ˆæœ¬

## æµ‹è¯•ä»£å¸

æµ‹è¯•æ–¹æ¡ˆå°±æ˜¯åœ¨è´¦æˆ·é—´äº’ç›¸è½¬è´¦ï¼Œé»˜è®¤ç»™äº†ç¬¬1ä¸ªè´¦æˆ·å…¨éƒ¨èµ„äº§ï¼Œå°±æµ‹è¯•ä»Žå®ƒå¾€å…¶ä»–è´¦æˆ·è½¬è´¦

```js title="testToken.js"
const Contacts = artifacts.require("DolToken.sol")
const fromWei = (bn)=>{
    return web3.utils.fromWei(bn,"ether");
}
const toWei = (number)=>{
    return web3.utils.toWei(number.toString(),"ether");
}
module.exports = async function(callback){
    const token = await Contacts.deployed()
    // è½¬è´¦
    await token.transfer('0x72e32551B6eF58bE2b125F09c4754Daa760d12f7',toWei(10000),{
        from:'0xD1Bc206C1Dba42Cf01A1427dA56e61Dda31dd2bf'
    })
    // èŽ·å–ç¬¬ä¸€ä¸ªè´¦å·
    const firstCount = await token.balanceOf
    ('0xD1Bc206C1Dba42Cf01A1427dA56e61Dda31dd2bf')
    console.log('ç¬¬ä¸€',fromWei(firstCount))
    // èŽ·å–ç¬¬äºŒä¸ªè´¦å·
    const secondCount = await token.balanceOf
    ('0x72e32551B6eF58bE2b125F09c4754Daa760d12f7')
    console.log('ç¬¬äºŒ',fromWei(secondCount))
    callback()
}
```

```
truffle exec ./scripts/testToken.js
```

å¤šæ¬¡æ‰§è¡Œæµ‹è¯•ï¼Œè½¬è´¦æˆåŠŸï¼Œé‡‘é¢ä¼šå˜åŒ–

![image-20230312130118724](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303121301806.png!blog.guiyexing)

## æ·»åŠ èµ„äº§

é™¤äº†åœ¨æŽ§åˆ¶å°æ‰“å°èµ„äº§ï¼Œè¿˜å¯ä»¥åˆ°æ’ä»¶é‡Œæ·»åŠ èµ„äº§

![image-20230312130411644](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303121304673.png!blog.guiyexing)

å¡«å†™å¿…è¦ä¿¡æ¯

* åˆçº¦åœ°å€ï¼šbuildç›®å½•çš„jsonæ–‡ä»¶ä¸­networksé‡Œçš„addresså­—æ®µ
* å…¶ä»–ä¸¤é¡¹ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œå¦åˆ™å¡«å…¥é…ç½®

![image-20230312130629622](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303121306661.png!blog.guiyexing)

æ·»åŠ æ—¶å¯ä»¥çœ‹åˆ°ä½™é¢ï¼Œæ·»åŠ åŽåº”å½“åœ¨ä¸»é¡µçœ‹åˆ°ï¼Œç›®å‰ä¸å¯ä»¥

![image-20230312131011231](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303121310260.png!blog.guiyexing)

## å§”æ‰˜äº¤æ˜“

æŠŠä¸€å®šæ•°é‡çš„èµ„äº§æŽˆæƒç»™äº¤æ˜“æ‰€ï¼Œç„¶åŽå¯ä»¥æŠŠä¸å¤§äºŽæŽˆæƒé‡‘é¢çš„èµ„é‡‘å­˜åˆ°äº¤æ˜“æ‰€ï¼Œå³è½¬è´¦ç»™äº¤æ˜“æ‰€è´¦å·

è½¬è´¦åˆ°äº¤æ˜“æ‰€éœ€è¦äº¤æ˜“æ‰€è°ƒç”¨ä»£å¸åˆçº¦ä¸­çš„transferFromï¼Œä»Žç”¨æˆ·è½¬è´¦åˆ°äº¤æ˜“æ‰€ä¸€å®šçš„é‡‘é¢

### æŽˆæƒ

approveè¿™ä¸ªå‡½æ•°å¾ˆé‡è¦ï¼Œä¸€æ—¦æŽˆæƒç»™ä¸è‰¯çš„åˆçº¦ï¼Œé’±å°±å¯èƒ½è¢«è½¬èµ°

äº‹ä»¶æ˜¯ä»¥å¤ªåŠä¸­ç‰¹æ®Šçš„æ•°æ®ç»“æž„ï¼Œä¼ çš„å‚æ•°éƒ½ä¼šè¢«æ°¸ä¹…çš„è®°å½•ï¼Œå°†æ¥å¯ä»¥å›žæº¯æ‹¿åˆ°è¿™äº›äº‹ä»¶ï¼Œå‰ç«¯ä¹Ÿå¯ä»¥è®¢é˜…äº‹ä»¶ï¼Œåªè¦æŽˆæƒå°±ä¼šæ”¶åˆ°å¯¹åº”çš„é€šçŸ¥

```solidityÂ title="DolToken.sol"
mapping(address => mapping(address => uint256)) public allowance;
event Approval(address indexed _owner, address indexed _spender, uint256 _value);
function approve(address _spender, uint256 _value) public returns (bool success){
    // msg.sender å½“å‰ç½‘é¡µç™»å½•è´¦å·
    // _spender ç¬¬ä¸‰æ–¹äº¤æ˜“æ‰€çš„è´¦å·åœ°å€
    // _value æŽˆæƒé’±æ•°
    require(_spender != address(0));
    allowance[msg.sender][_spender] = _value;
    emit Approval(msg.sender,_spender,_value);
    return true;
    /*
        ä¸åŒè´¦å·æŽˆæƒç»™ä¸åŒäº¤æ˜“æ‰€çš„é¢åº¦çš„Jsæ•°æ®ç»“æž„
        {
            user1:{
                A:100,
                B:200,
            }
            user2:{
                A:100,
                C:200,
            }
        }
        */
}
```

### ä»Žè´¦æˆ·Aè½¬åˆ°è´¦æˆ·B

å®žçŽ°transferFromæ–¹æ³•ï¼Œè¢«æŽˆæƒçš„äº¤æ˜“æ‰€è°ƒç”¨

```solidityÂ title="DolToken.sol"
function transferFrom(address _from, address _to, uint256 _value) public returns (bool success){
    // _fromæŸä¸ªæ”¾æ¬¾è´¦å·
    // _to æ”¶æ¬¾è´¦å·
    // msg.sender äº¤æ˜“æ‰€è´¦å·åœ°å€
    require(balanceOf[_from] >= _value);
    require(allowance[_from][msg.sender] >= _value);//è´¦æˆ·å’ŒæŽˆæƒäº†çš„é‡‘é¢ä¸å°äºŽå½“å‰è½¬è´¦é‡‘é¢
    // ä»ŽæŽˆæƒé‡‘é¢ä¸­å‡åŽ»å‡†å¤‡è½¬è´¦çš„å€¼
    allowance[_from][msg.sender] = allowance[_from][msg.sender].sub(_value);
    // è½¬è´¦
    _transfer(_from,_to,_value);
    return true;
}
```

## äº¤æ˜“æ‰€

### å­˜æ¬¾

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªäº¤æ˜“æ‰€çš„åˆçº¦`Exchange.sol`ï¼Œäº¤æ˜“æ‰€å­˜è´§å¸çš„æ•°æ®ç»“æž„jsonè¡¨ç¤ºå¦‚ä¸‹

```json
{
    "ä»¥å¤ªå¸åœ°å€":{
        "Aç”¨æˆ·":100,
        "Bç”¨æˆ·":200,
    },
    "DOLå¸åœ°å€":{
        "Aç”¨æˆ·":100,
        "Bç”¨æˆ·":200,
    },
}
```

äº¤æ˜“æ‰€æœ¬èº«çš„åœ°å€æ˜¯ä¸€ä¸ªè½¬è´¦åœ°å€ï¼Œç”¨æˆ·æŽˆæƒåŽæŠŠé’±è½¬ç»™äº¤æ˜“æ‰€ï¼ŒåŒæ—¶è¿˜éœ€è¦é…ç½®å¦å¤–çš„æ”¶è´¹è´¦æˆ·åœ°å€ï¼Œå¦‚æ”¶å–æ‰‹ç»­è´¹ï¼Œè¿˜éœ€è¦é…ç½®è´¹çŽ‡

ä¸‹é¢å®žçŽ°äº†å­˜å‚¨ä»¥å¤ªå¸å’Œå…¶ä»–è´§å¸çš„æ–¹æ³•

```solidity title="Exchange.sol"
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.4.16 <0.9.0;
// å¯¼å…¥å®‰å…¨æ•°å­¦æ–¹æ³•
import "openzeppelin-solidity/contracts/math/SafeMath.sol";
import "./DolToken.sol";
contract Exchange {
    using SafeMath for uint256;//ä¸ºuint256åŽé¢ä½¿ç”¨subï¼Œaddæ–¹æ³•
    // æ”¶è´¹è´¦æˆ·åœ°å€
    address public feeAccount;
    uint256 public feePercent;// è´¹çŽ‡
    mapping(address => mapping(address => uint256)) public tokens;
    address constant ETHER = address(0);
    constructor(address _feeAccount,uint256 _feePercent){
        feeAccount = _feeAccount;
        feePercent = _feePercent;
    }
    event Deposit(address token,address user,uint256 amount,uint256 balance);
    // ä»¥å¤ªå¸
    function depositEther() payable public{
        // æœ‰payableæ‰èƒ½åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œä»Žmsg.senderä¸­åˆ’msg.valueåˆ°åˆçº¦éƒ¨ç½²çš„åœ°å€,æ³¨æ„ï¼šçœŸçš„ä¼šè½¬
        tokens[ETHER][msg.sender] = tokens[ETHER][msg.sender].add(msg.value);
        emit Deposit(ETHER, msg.sender, msg.value, tokens[ETHER][msg.sender]);
    }
    // å­˜å…¶ä»–è´§å¸
    function depositToken(address _token,uint256 _amount) public{
        // _tokenè¦å­˜çš„ç±»åž‹è´§å¸çš„åœ°å€ï¼Œ_amountè¦å­˜çš„é‡‘é¢
        require(_token != ETHER);
        // address(this)å½“å‰äº¤æ˜“æ‰€åœ°å€ï¼Œè¡¨ç¤ºæŠŠé’±è½¬åˆ°å½“å‰äº¤æ˜“æ‰€ï¼Œmsg.senderå½“å‰å­˜é’±ç”¨æˆ·
        require(DolToken(_token).transferFrom(msg.sender,address(this),_amount));
        // è½¬è´¦æˆåŠŸåŽåœ¨äº¤æ˜“æ‰€é‡Œè®°å½•å€¼
        tokens[_token][msg.sender] = tokens[_token][msg.sender].add(_amount);
        emit Deposit(_token, msg.sender, _amount, tokens[_token][msg.sender]);
    }
}
```

éƒ¨ç½²ï¼Œå†™åˆ°ä¸€èµ·çš„æ–¹æ³•ï¼Œå¯ä»¥èŽ·å–web3çš„apiï¼Œä¼ å…¥ç¬¬1ä¸ªè´¦å·ï¼Œè´¹çŽ‡ä¸º2

```js title="3_Token.js"
const Contacts = artifacts.require("DolToken.sol")
const Exchange = artifacts.require("Exchange.sol")
module.exports = async function(deployer){
    const accounts = await web3.eth.getAccounts()
    await deployer.deploy(Contacts)
    await deployer.deploy(Exchange,accounts[0],2)
}
```

å­˜æ¬¾æµ‹è¯•

```js title="testExchange.js"
const DolToken = artifacts.require("DolToken.sol")
const Exchange = artifacts.require("Exchange.sol")

const fromWei = (bn)=>{
    return web3.utils.fromWei(bn,"ether");
}
const toWei = (number)=>{
    return web3.utils.toWei(number.toString(),"ether");
}
const ETHER_ADDRESS = '0x0000000000000000000000000000000000000000';//address(0)é»˜è®¤åœ°å€0xåŽ40ä¸ª0
module.exports = async function(callback){
    const token = await DolToken.deployed()
    const exchange = await Exchange.deployed()
    const accounts = await web3.eth.getAccounts()
    // å­˜å‚¨ä»¥å¤ªåŠå¸æµ‹è¯•
   /*  await exchange.depositEther({
        from:accounts[0],
        value:toWei(10)
    })
    let ret = await exchange.tokens(ETHER_ADDRESS,accounts[0])
    console.log(fromWei(ret)) */
    // 1.æŽˆæƒ
    await token.approve(exchange.address,toWei(10000),{
        from:accounts[0]
    })
    // 2.å­˜å‚¨
    await exchange.depositToken(token.address,toWei(10000),{
        from:accounts[0]
    })
    // 3.æŸ¥çœ‹ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ç´¯è®¡å­˜10000ï¼Œè¿˜å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ä»£å¸æŸ¥çœ‹å‰©ä½™
    let ret1 = await exchange.tokens(token.address,accounts[0])
    let ret2 = await token.balanceOf(accounts[0])
    console.log(fromWei(ret1),fromWei(ret2))

    callback()
}
```

### å–æ¬¾

äº¤æ˜“æ‰€å–æ¬¾é€»è¾‘

```solidity title="Exchange.sol"
event WithDraw(address token,address user,uint256 amount,uint256 balance);
// æå–ä»¥å¤ªå¸
function withdrawEther(uint256 _amount) public {
    // å½“å‰è´¦å·æœ‰ä¸å°äºŽè¯¥æ•°é¢çš„é’±
    require(tokens[ETHER][msg.sender] >= _amount);
    // æŠŠè®°å½•å‡å°‘
    tokens[ETHER][msg.sender] = tokens[ETHER][msg.sender].sub(_amount);
    // ä½¿ç”¨payableè½¬è´¦ï¼ŒæŠŠå½“å‰äº¤æ˜“æ‰€è´¦æˆ·çš„_amountçš„ä»¥å¤ªå¸è½¬ç»™å½“å‰è´¦æˆ·
    payable(msg.sender).transfer(_amount);
    // è§¦å‘WithDrawäº‹ä»¶
    emit WithDraw(ETHER, msg.sender, _amount, tokens[ETHER][msg.sender]);
}
// æå–å…¶ä»–å¸
function withdrawToken(address _token,uint256 _amount) public {
    // _tokenè¦å–çš„ç±»åž‹è´§å¸çš„åœ°å€ï¼Œ_amountè¦å–çš„é‡‘é¢
    require(_token != ETHER);
    // å½“å‰è´¦å·æœ‰ä¸å°äºŽè¯¥æ•°é¢çš„é’±
    require(tokens[_token][msg.sender] >= _amount);
    // æŠŠè®°å½•å‡å°‘
    tokens[_token][msg.sender] = tokens[_token][msg.sender].sub(_amount);
    // è½¬è´¦ï¼Œæ‹¿åˆ°åˆçº¦è´§å¸çš„å®žä¾‹ï¼Œå½“å‰åˆçº¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯¹åº”transferå†…çš„msg.senderå°±æ˜¯äº¤æ˜“æ‰€è´¦æˆ·
    require(DolToken(_token).transfer(msg.sender, _amount));
    // è§¦å‘WithDrawäº‹ä»¶
    emit WithDraw(_token, msg.sender, _amount, tokens[_token][msg.sender]);
}
// æ·»åŠ æŸ¥ä½™é¢æ–¹æ³•å¯¹æ ‡ä»£å¸æŸ¥è¯¢æ–¹æ³•
function balanceOf(address _token,address _user) public view returns (uint256) {
	return tokens[_token][_user];
}
```

æµ‹è¯•æ–¹æ¡ˆï¼Œé¦–å…ˆä½¿ç”¨`testExchange`è„šæœ¬å­˜æ¬¾ï¼Œç„¶åŽä½¿ç”¨`testExchangeDraw`è„šæœ¬å–æ¬¾

å–æ¬¾è„šæœ¬å¦‚ä¸‹

```js title="testExchangeDraw.js"
const DolToken = artifacts.require("DolToken.sol")
const Exchange = artifacts.require("Exchange.sol")

const fromWei = (bn)=>{
    return web3.utils.fromWei(bn,"ether");
}
const toWei = (number)=>{
    return web3.utils.toWei(number.toString(),"ether");
}
const ETHER_ADDRESS = '0x0000000000000000000000000000000000000000';//address(0)é»˜è®¤åœ°å€0xåŽ40ä¸ª0
module.exports = async function(callback){
    const token = await DolToken.deployed()
    const exchange = await Exchange.deployed()
    const accounts = await web3.eth.getAccounts()
    // æå–ä»¥å¤ªåŠå¸æµ‹è¯•
    await exchange.withdrawEther(toWei(2),{
        from:accounts[0],
    })
    let ret = await exchange.balanceOf(ETHER_ADDRESS,accounts[0])
    console.log(fromWei(ret))
    // æå–ä¸éœ€è¦æŽˆæƒ
    await exchange.withdrawToken(token.address,toWei(500),{
        from:accounts[0]
    })
    // 3.æŸ¥çœ‹ç»“æžœ
    let ret1 = await exchange.balanceOf(token.address,accounts[0])
    let ret2 = await token.balanceOf(accounts[0])
    console.log(fromWei(ret1),fromWei(ret2))

    callback()
}
```

![image-20230314193910973](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303141939089.png!blog.guiyexing)

### æµåŠ¨æ± 

åˆ›å»ºè®¢å•ï¼ŒåŒ…å«è®¢å•idï¼Œåˆ›å»ºäººï¼Œåˆ›å»ºæ—¶é—´ï¼Œå‡†å¤‡å…‘æ¢è´§å¸ç±»åž‹ï¼Œå‡†å¤‡å…‘æ¢è´§å¸é‡‘é¢ï¼Œç›®æ ‡å…‘æ¢è´§å¸ç±»åž‹ï¼Œç›®æ ‡å…‘æ¢è´§å¸é‡‘é¢ï¼Œè®¢å•çŠ¶æ€

```solidity title="Exchange.sol"
// è®¢å•ç»“æž„ä½“
struct _Order {
    uint256 id;
    address createUser;
    address tokenFrom;
    uint256 amountFrom;
    address tokenTo;
    uint256 amountTo;
    uint256 timestamp;
    uint16 status; //0åˆ›å»º1å®Œæˆ2å–æ¶ˆ
}
// _Order[] orderList;//åŠ¨æ€æ•°ç»„å½¢å¼
mapping(uint256 => _Order) public orders; //mapingç»“æž„
uint256 public orderCount; //è®°å½•æ€»çš„è®¢å•æ•°
// åˆ›å»ºè®¢å•äº‹ä»¶
event Order(
    uint256 id,
    address createUser,
    address tokenFrom,
    uint256 amountFrom,
    address tokenTo,
    uint256 amountTo,
    uint256 timestamp
);

// åˆ›å»ºè®¢å•
function makeOrder(
    address _tokenFrom,
    uint256 _amountFrom,
    address _tokenTo,
    uint256 _amountTo
) public {
    require(balanceOf(_tokenFrom, msg.sender) >= _amountFrom,unicode'åˆ›å»ºè®¢å•æ—¶ä½™é¢ä¸è¶³');
    orderCount = orderCount.add(1);
    orders[orderCount] = _Order(
        orderCount,
        msg.sender,
        _tokenFrom,
        _amountFrom,
        _tokenTo,
        _amountTo,
        block.timestamp,
        0
    );
    // å‘å‡ºè®¢å•äº‹ä»¶
    emit Order(
        orderCount,
        msg.sender,
        _tokenFrom,
        _amountFrom,
        _tokenTo,
        _amountTo,
        block.timestamp
    );
}
```

### å–æ¶ˆè®¢å•

ä¿®æ”¹çŠ¶æ€ä¸º2

```solidity title="Exchange.sol"
//å–æ¶ˆè®¢å•äº‹ä»¶
event Cancel(
    uint256 id,
    address createUser,
    address tokenFrom,
    uint256 amountFrom,
    address tokenTo,
    uint256 amountTo,
    uint256 timestamp
);
// å–æ¶ˆè®¢å•
function cancelOrder(uint _id) public {
    _Order memory myorder = orders[_id];
    require(myorder.id == _id);
    require(myorder.createUser == msg.sender);
    // ä¿®æ”¹çŠ¶æ€
    orders[_id] = _Order(
        myorder.id,
        myorder.createUser,
        myorder.tokenFrom,
        myorder.amountFrom,
        myorder.tokenTo,
        myorder.amountTo,
        myorder.timestamp,
        2
    );//åˆ›å»ºæ—¶é—´ä¸å˜
    // å‘å‡ºå–æ¶ˆäº‹ä»¶
    emit Cancel(
        myorder.id,
        myorder.createUser,
        myorder.tokenFrom,
        myorder.amountFrom,
        myorder.tokenTo,
        myorder.amountTo,
        block.timestamp
    );//å–æ¶ˆæ—¶é—´
}
```

### å®Œæˆäº¤æ˜“

æ¶‰åŠä¿®æ”¹çŠ¶æ€ï¼Œæ”¹å˜åœ¨äº¤æ˜“æ‰€çš„é‡‘é¢ï¼Œæ”¶å–å°è´¹ï¼Œéœ€ä¼˜åŒ–å†»ç»“é‡‘é¢æˆ–è€…åˆ¤æ–­

```solidity title="Exchange.sol"
// å®Œæˆè®¢å•äº‹ä»¶
event Trade(
    uint256 id,
    address createUser,
    address tokenFrom,
    uint256 amountFrom,
    address tokenTo,
    uint256 amountTo,
    uint256 timestamp
);
// å®Œæˆè®¢å•
function fillOrder(uint _id) public {
    _Order memory myorder = orders[_id];
    require(myorder.id == _id);
    // msg.senderæ˜¯è¦å®Œæˆå…‘æ¢çš„äºº
    // äº¤æ˜“&æ‰‹ç»­è´¹
    require(
        _trade(
            myorder.createUser,
            myorder.tokenFrom,
            myorder.amountFrom,
            myorder.tokenTo,
            myorder.amountTo,
            msg.sender
        )
    );
    // todo å®Œæˆäº¤æ˜“ï¼Œå¯ä»¥è¡¥å……å®Œæˆäº¤æ˜“çš„æ—¶é—´å’Œç”¨æˆ·ï¼Œå¦å¤–å­˜å‚¨æˆ–æ”¹é€ ç»“æž„ä½“
    // ä¿®æ”¹çŠ¶æ€
    orders[_id] = _Order(
        myorder.id,
        myorder.createUser,
        myorder.tokenFrom,
        myorder.amountFrom,
        myorder.tokenTo,
        myorder.amountTo,
        myorder.timestamp,
        1
    );
    emit Trade(
        myorder.id,
        msg.sender,
        myorder.tokenFrom,
        myorder.amountFrom,
        myorder.tokenTo,
        myorder.amountTo,
        block.timestamp
    );//å®Œæˆäººï¼Œå®Œæˆæ—¶é—´
}

// äº¤æ˜“ï¼šåˆ›å»ºäººï¼Œå‡†å¤‡å…‘æ¢è´§å¸ç±»åž‹ï¼Œå‡†å¤‡å…‘æ¢è´§å¸é‡‘é¢ï¼Œç›®æ ‡å…‘æ¢è´§å¸ç±»åž‹ï¼Œç›®æ ‡å…‘æ¢è´§å¸é‡‘é¢ï¼Œå®Œæˆäºº
function _trade(
    address _createUser,
    address _tokenFrom,
    uint256 _amountFrom,
    address _tokenTo,
    uint256 _amountTo,
    address _fillUser
) internal returns (bool) {
    // è®¡ç®—å°è´¹ï¼Œå®Œæˆè®¢å•çš„äººæ”¯ä»˜ï¼Œä»Žç›®æ ‡å…‘æ¢è´§å¸é‡‘é¢ä¸­è®¡ç®—
    uint256 feeAmount = _amountTo.mul(feePercent).div(100);
    // ä¸¤æ–¹çš„å­˜æ¬¾è¦è¶³å¤Ÿ
    require(balanceOf(_tokenFrom, _createUser) >= _amountFrom,unicode'åˆ›å»ºè®¢å•ç”¨æˆ·ä½™é¢ä¸è¶³');
    require(balanceOf(_tokenTo, _fillUser) >= _amountTo.add(feeAmount),unicode'å®Œæˆè®¢å•ä½™é¢ä¸è¶³');
    // todoä¼˜åŒ–ï¼Œåˆ›å»ºäººä¸è¶³ä¼šäº§ç”Ÿåè´¦å•ï¼Œä¸èƒ½äº¤æ¢ï¼Œç”šè‡³å‘èµ·äººåˆ›å»ºè®¢å•åŽèµ„æºå¯ä»¥æ‰©å±•å†»ç»“
    // é’ˆå¯¹ä¸‹å•äºº
    tokens[_tokenFrom][_createUser] = tokens[_tokenFrom][_createUser].sub(
        _amountFrom
    );
    tokens[_tokenTo][_createUser] = tokens[_tokenTo][_createUser].add(
        _amountTo
    );
    // é’ˆå¯¹å®Œæˆè®¢å•çš„äºº
    tokens[_tokenFrom][_fillUser] = tokens[_tokenFrom][_fillUser].add(
        _amountFrom
    );
    tokens[_tokenTo][_fillUser] = tokens[_tokenTo][_fillUser].sub(
        _amountTo.add(feeAmount)
    ); //å¤šå‡è´¹ç”¨
    // æŠŠå°è´¹ç»™é…ç½®çš„è´¦æˆ·
    tokens[_tokenTo][feeAccount] = tokens[_tokenTo][feeAccount].add(
        feeAmount
    );
    return true;
}
```

### æµ‹è¯•è®¢å•

æ•…äº‹ï¼šè´¦æˆ·1æƒ³æ‹¿1ETHå…‘æ¢100DOLï¼Œäº¤æ˜“åŽèµ„é‡‘ä¼šå­˜æ”¾åœ¨äº¤æ˜“æ‰€

åˆå§‹åŒ–æ—¶é»˜è®¤10ä¸ªè´¦å·å„è‡ªæœ‰1000ETHï¼Œå‰é¢æµ‹è¯•äº¤æ˜“å¯èƒ½æœ‰äº›å˜åŠ¨ï¼Œç¬¬ä¸€ä¸ªè´¦æˆ·æœ‰é»˜è®¤æœ‰å…¨éƒ¨çš„DOLå¸ï¼Œè½¬ç»™è´¦æˆ·2ä¸€å®šçš„DOLå¸

1. è´¦æˆ·1å­˜åˆ°äº¤æ˜“æ‰€ä¸€å®šé‡ETHï¼Œå¦‚50
2. è´¦æˆ·2å­˜åˆ°äº¤æ˜“æ‰€ä¸€å®šé‡DOLï¼Œå¦‚10000
3. è´¦æˆ·1åˆ›å»ºè®¢å•1ETHå…‘æ¢100DOLï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€0
4. è´¦æˆ·1å–æ¶ˆè®¢å•ï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€2
5. è´¦æˆ·1å†æ¬¡åˆ›å»ºæ–°è®¢å•1ETHå…‘æ¢100DOLï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€0
6. è´¦æˆ·2å®Œæˆè®¢å•ï¼Œè®¢å•çŠ¶æ€ä¸º1
7. æŸ¥çœ‹è´¦å·1å’Œ2åœ¨äº¤æ˜“æ‰€çš„é‡‘é¢ï¼Œæ³¨æ„å°è´¹æ‰£é™¤(é…ç½®äº†2%)ï¼Œäº¤æ˜“å®ŒæˆåŽäº¤æ˜“æ‰€é‡Œè´¦æˆ·1å‰©ä½™ã€49ETHã€100DOLã€‘ï¼Œè´¦æˆ·2å‰©ä½™ã€1ETHã€10000 - (100 + 100*2%)ã€‘ï¼Œæ”¶è´¹è´¦å·é…ç½®äº†ç¬¬ä¸€ä¸ªè´¦æˆ·ï¼Œä¼šæŠŠå°è´¹ç»™ç¬¬ä¸€ä¸ªè´¦æˆ·ï¼Œå°±ä¼šå˜æˆ102DOL

æµ‹è¯•ä»£ç å¦‚ä¸‹

```js title="testOrder.js"
const DolToken = artifacts.require("DolToken.sol")
const Exchange = artifacts.require("Exchange.sol")

const fromWei = (bn)=>{
    return web3.utils.fromWei(bn,"ether");
}
const toWei = (number)=>{
    return web3.utils.toWei(number.toString(),"ether");
}
const ETHER_ADDRESS = '0x0000000000000000000000000000000000000000';//address(0)é»˜è®¤åœ°å€0xåŽ40ä¸ª0
module.exports = async function(callback){
    const token = await DolToken.deployed()
    const exchange = await Exchange.deployed()
    const accounts = await web3.eth.getAccounts()
    const [one,two] = accounts
    try {
        // åˆå§‹åŒ–æŸ¥è¯¢
        await token.transfer(two,toWei(100000),{
            from: one
        })
        const initAssets = await getAssets(accounts,exchange,token)
        console.log(initAssets,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜ŽinitAssets');
        // 1. è´¦æˆ·1å­˜åˆ°äº¤æ˜“æ‰€ä¸€å®šé‡ETHï¼Œå¦‚50
        await exchange.depositEther({
            from: one,
            value: toWei(50)
        })
        // 2. è´¦æˆ·2å­˜åˆ°äº¤æ˜“æ‰€ä¸€å®šé‡DOLï¼Œå¦‚10000
        await token.approve(exchange.address,toWei(10000),{
            from:two
        })//æŽˆæƒ
        await exchange.depositToken(token.address,toWei(10000),{
            from: two,
        })//è½¬è´¦
        const deposit = await getAssets(accounts,exchange,token)
        console.log(deposit,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜Ždeposit');
        // 3. è´¦æˆ·1åˆ›å»ºè®¢å•1ETHå…‘æ¢100DOLï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€0
        const order1 = await exchange.makeOrder(ETHER_ADDRESS,toWei(1),token.address,toWei(100),{
            from: one
        })
        const id1 = order1.logs[0].args.id; // èŽ·å–ä¿¡æ¯çš„æ–¹å¼
        const initOrder1 = await getOrder(exchange,id1)
        console.log(initOrder1,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜ŽinitOrder1');
        // 4. è´¦æˆ·1å–æ¶ˆè®¢å•ï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€2
        await exchange.cancelOrder(id1,{
            from: one
        })
        const order1Cancel = await getOrder(exchange,id1)
        console.log(order1Cancel,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜Žorder1Cancel');
        // 5. è´¦æˆ·1å†æ¬¡åˆ›å»ºæ–°è®¢å•1ETHå…‘æ¢100DOLï¼ŒæŸ¥çœ‹è®¢å•çŠ¶æ€0
        const order2 = await exchange.makeOrder(ETHER_ADDRESS,toWei(1),token.address,toWei(100),{
            from: one
        })
        const id2 = order2.logs[0].args.id; // èŽ·å–ä¿¡æ¯çš„æ–¹å¼
        const initOrder2 = await getOrder(exchange,id2)
        console.log(initOrder2,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜ŽinitOrder2');
        // 6. è´¦æˆ·2å®Œæˆè®¢å•ï¼Œè®¢å•çŠ¶æ€ä¸º1
        await exchange.fillOrder(id2,{
            from:two
        })
        const Order2Fill = await getOrder(exchange,id2)
        console.log(Order2Fill,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜ŽOrder2Fill');
        // 7. æŸ¥çœ‹è´¦å·1å’Œ2åœ¨äº¤æ˜“æ‰€çš„é‡‘é¢ï¼Œæ³¨æ„å°è´¹æ‰£é™¤(é…ç½®äº†2%)ï¼Œäº¤æ˜“å®ŒæˆåŽäº¤æ˜“æ‰€é‡Œè´¦æˆ·1å‰©ä½™ã€49ETHã€100DOLã€‘ï¼Œè´¦æˆ·2å‰©ä½™ã€1ETHã€10000 - (100 + 100*2%)ã€‘ï¼Œç¬¬ä¸€ä¸ªè´¦å·ä¹Ÿä¼šç´¯è®¡2%å°è´¹
        const finalAssets = await getAssets(accounts,exchange,token)
        console.log(finalAssets,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜ŽfinalAssets');
    } catch (error) {
        console.log(error,'æ•°æ®ðŸ˜ŽðŸ˜ŽðŸ˜Žerror');
    }
    callback()
}

const getAssets = async (accounts,exchange,token) => {
    const [one,two] = accounts
    // è´¦æˆ·1å’Œ2åœ¨äº¤æ˜“æ‰€çš„ETHå’ŒDOL
    const oneExchangeETH = await exchange.balanceOf(ETHER_ADDRESS,one)
    const twoExchangeETH = await exchange.balanceOf(ETHER_ADDRESS,two)
    const oneExchangeDOL = await exchange.balanceOf(token.address,one)
    const twoExchangeDOL = await exchange.balanceOf(token.address,two)
    // è´¦æˆ·1å’Œ2æœ¬èº«çš„ETHå’ŒDOL
    const oneSelfDOL = await token.balanceOf(one)
    const twoSelfDOL = await token.balanceOf(two)
    const oneSelfETH = await web3.eth.getBalance(one);
    const twoSelfETH = await web3.eth.getBalance(two);

    return {
        oneExchangeETH: fromWei(oneExchangeETH),
        twoExchangeETH: fromWei(twoExchangeETH),
        oneExchangeDOL: fromWei(oneExchangeDOL),
        twoExchangeDOL: fromWei(twoExchangeDOL),
        oneSelfDOL: fromWei(oneSelfDOL),
        twoSelfDOL: fromWei(twoSelfDOL),
        oneSelfETH: fromWei(oneSelfETH),
        twoSelfETH: fromWei(twoSelfETH),
    }
}
const getOrder = async (exchange,id) =>{
    return exchange.orders(id)
}
```

![image-20230315144441001](https://blog-guiyexing.oss-cn-qingdao.aliyuncs.com/blogImg/202303151444114.png!blog.guiyexing)
